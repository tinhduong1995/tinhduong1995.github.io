<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Bii Coffee - Đặt hàng</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #6f4e37;
      --secondary: #c0a080;
      --accent: #d8a868;
      --light: #f5f5f5;
      --dark: #333;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --telegram: #0088cc;
      --size-s: #4caf50;
      --size-l: #ff9800;
      --bubble-white: #f5f5f5;
      --bubble-black: #333;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background-color: #f9f6f2;
      padding: 15px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    
    #authHeader {
      position: absolute;
      top: 15px;
      right: 15px;
    }
    
    #loginBtn, #logoutBtn {
      background-color: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    
    #loginBtn:hover, #logoutBtn:hover {
      background-color: rgba(255,255,255,0.3);
    }
    
    h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }
    
    /* Topping status bar */
    .topping-status {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 40px;
      flex-wrap: wrap;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 15px;
      border-radius: 30px;
      background: white;
      color: var(--dark);
      font-weight: 500;
    }
    
    .bubble-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }
    
    .bubble-white {
      background: var(--bubble-white);
      border: 2px solid #ddd;
    }
    
    .bubble-black {
      background: var(--bubble-black);
    }
    
    .status-available {
      color: var(--success);
      font-weight: bold;
    }
    
    .status-out {
      color: var(--danger);
      font-weight: bold;
    }
    
    h2 {
      color: var(--primary);
      margin-bottom: 12px;
      padding-bottom: 6px;
      border-bottom: 2px solid var(--secondary);
      font-size: 1.3rem;
    }
    
    h3 {
      font-size: 1rem;
      color: var(--primary);
      margin-bottom: 10px;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .section {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .flex {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
      align-items: center;
    }
    
    input, select, button, textarea {
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 0.95rem;
      width: 100%;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(216, 168, 104, 0.2);
    }
    
    button {
      background-color: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      width: auto;
    }
    
    button:hover {
      background-color: var(--secondary);
    }
    
    button.success {
      background-color: var(--success);
    }
    
    button.success:hover {
      background-color: #218838;
    }
    
    button.warning {
      background-color: var(--warning);
      color: var(--dark);
    }
    
    button.warning:hover {
      background-color: #e0a800;
    }
    
    /* Size selector */
    .size-selector {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    
    .size-btn {
      flex: 1;
      padding: 5px;
      font-size: 0.8rem;
      background-color: #f0f0f0;
      color: var(--dark);
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .size-btn.small-active {
      background-color: var(--size-s);
      color: white;
      border-color: var(--size-s);
    }
    
    .size-btn.large-active {
      background-color: var(--size-l);
      color: white;
      border-color: var(--size-l);
    }
    
    /* Customer info form */
    .customer-info {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #e9ecef;
    }
    
    .customer-info h3 {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
      margin-bottom: 15px;
    }
    
    .customer-info h3 i {
      color: var(--telegram);
    }
    
    .input-group {
      margin-bottom: 12px;
    }
    
    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--dark);
    }
    
    .input-group input, .input-group textarea {
      background-color: white;
    }
    
    .input-group input:focus, .input-group textarea:focus {
      border-color: var(--telegram);
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-with-icon i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #aaa;
    }
    
    .input-with-icon input {
      padding-left: 35px;
    }
    
    /* Order summary */
    .order-summary {
      background-color: #fff3e0;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      border-left: 4px solid var(--accent);
    }
    
    .order-summary p {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    
    .order-summary .total {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--primary);
      border-top: 1px dashed var(--secondary);
      padding-top: 8px;
      margin-top: 8px;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }
    
    .modal-content {
      background-color: white;
      padding: 25px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .close {
      font-size: 1.5rem;
      cursor: pointer;
    }
    
    .close:hover {
      color: var(--danger);
    }
    
    /* Confirm order modal */
    .confirm-items {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    
    .confirm-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px dotted #eee;
    }
    
    .confirm-item:last-child {
      border-bottom: none;
    }
    
    .confirm-info {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .confirm-info p {
      margin: 8px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .confirm-info i {
      width: 20px;
      color: var(--primary);
    }
    
    .confirm-total {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--success);
      text-align: right;
      margin-top: 10px;
    }
    
    /* Category filter */
    .category-filter {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      max-height: 100px;
      overflow-y: auto;
      padding: 5px;
    }
    
    .category-btn {
      padding: 8px 15px;
      background-color: #f0f0f0;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
      transition: all 0.3s;
    }
    
    .category-btn:hover {
      background-color: var(--secondary);
      color: white;
    }
    
    .category-btn.active {
      background-color: var(--primary);
      color: white;
    }
    
    /* Menu grid */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 450px;
      overflow-y: auto;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    
    .menu-item {
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s;
    }
    
    .menu-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    
    .menu-item-name {
      font-weight: bold;
      font-size: 1rem;
      color: var(--primary);
    }
    
    .menu-item-price {
      font-weight: bold;
      font-size: 0.95rem;
    }
    
    .price-small {
      color: var(--size-s);
    }
    
    .price-large {
      color: var(--size-l);
      margin-left: 5px;
    }
    
    .price-single {
      color: var(--primary);
    }
    
    .add-to-cart-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 8px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-size: 0.9rem;
      margin-top: 5px;
    }
    
    .add-to-cart-btn:hover {
      background: #218838;
    }
    
    /* Cart table */
    .cart-table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 0.9rem;
    }
    
    .cart-table th {
      background: var(--primary);
      color: white;
      padding: 10px;
      text-align: left;
    }
    
    .cart-table td {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .cart-table button {
      padding: 2px 8px;
      font-size: 0.8rem;
    }
    
    .size-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.7rem;
      font-weight: bold;
      margin-left: 5px;
    }
    
    .size-s-badge {
      background-color: var(--size-s);
      color: white;
    }
    
    .size-l-badge {
      background-color: var(--size-l);
      color: white;
    }
    
    /* Admin sections */
    .admin-only {
      display: none;
    }
    
    .admin-only.visible {
      display: block;
    }
    
    .admin-badge {
      background-color: var(--warning);
      color: var(--dark);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      display: inline-block;
      margin-left: 10px;
    }
    
    /* Stats */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-box {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .stat-value {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--primary);
      margin-top: 5px;
    }
    
    /* Notification */
    .notification {
      position: fixed;
      top: 15px;
      right: 15px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      background-color: var(--success);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 80%;
      font-size: 0.95rem;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background-color: var(--danger);
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 10px;
      color: #ddd;
    }
    
    /* Required field indicator */
    .required::after {
      content: " *";
      color: var(--danger);
    }
    
    /* Order list in admin */
    .order-card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .order-status {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-new {
      background-color: #28a745;
      color: white;
    }
    
    .status-processing {
      background-color: #ffc107;
      color: var(--dark);
    }
    
    .status-completed {
      background-color: #6c757d;
      color: white;
    }
    
    .order-actions {
      display: flex;
      gap: 5px;
      margin-top: 10px;
    }
    
    .order-actions button {
      flex: 1;
      padding: 8px;
      font-size: 0.8rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .menu-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      
      .stats-container {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-coffee"></i> Bii Coffee</h1>
    <p>Quán quen - Giá quen - Vị quen</p>
    
    <!-- Topping Status Bar -->
    <div class="topping-status" id="toppingStatus">
      <div class="status-item">
        <span class="bubble-dot bubble-white"></span>
        <span>Trân châu trắng:</span>
        <span id="whiteBubbleStatus" class="status-available">Còn</span>
      </div>
      <div class="status-item">
        <span class="bubble-dot bubble-black"></span>
        <span>Trân châu đen:</span>
        <span id="blackBubbleStatus" class="status-available">Còn</span>
      </div>
    </div>
    
    <div id="authHeader">
      <button id="loginBtn" onclick="showLoginModal()"><i class="fas fa-lock"></i> Quản lý</button>
      <button id="logoutBtn" onclick="logout()" style="display: none;"><i class="fas fa-sign-out-alt"></i> Đăng xuất</button>
    </div>
  </header>

  <div class="container">
    <!-- PUBLIC ORDER SECTION -->
    <div class="section">
      <h2><i class="fas fa-shopping-cart"></i> Đặt hàng</h2>
      
      <!-- Category Filter -->
      <div class="category-filter" id="categoryFilter"></div>
      
      <!-- Menu Grid -->
      <div class="menu-grid" id="menuGrid"></div>
      
      <!-- Cart -->
      <table class="cart-table" id="cartTable">
        <thead>
          <tr>
            <th>Món (Size)</th>
            <th>SL</th>
            <th>Đơn giá</th>
            <th>Thành tiền</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cartBody"></tbody>
      </table>
      
      <!-- Customer Info -->
      <div class="customer-info">
        <h3>
          <i class="fas fa-user-circle"></i> Thông tin ship hàng
        </h3>
        
        <div class="input-group">
          <label class="required">Số điện thoại</label>
          <div class="input-with-icon">
            <i class="fas fa-phone-alt"></i>
            <input type="tel" id="customerPhone" placeholder="Nhập số điện thoại" value="">
          </div>
        </div>
        
        <div class="input-group">
          <label class="required">Địa chỉ ship</label>
          <div class="input-with-icon">
            <i class="fas fa-map-marker-alt"></i>
            <input type="text" id="customerAddress" placeholder="Nhập địa chỉ nhận hàng" value="">
          </div>
        </div>
        
        <div class="input-group">
          <label>Ghi chú thêm</label>
          <textarea id="orderNote" rows="2" placeholder="Ví dụ: ít đá, không đường, gọi trước khi giao..."></textarea>
        </div>
      </div>
      
      <!-- Order Summary -->
      <div class="order-summary">
        <p>
          <span>Tạm tính:</span>
          <span id="subtotal">0đ</span>
        </p>
        <p>
          <span>Phí giao hàng:</span>
          <span>0đ</span>
        </p>
        <p class="total">
          <span>Tổng cộng:</span>
          <span id="cartTotal">0đ</span>
        </p>
      </div>
      
      <!-- Submit Button -->
      <button onclick="showConfirmModal()" class="success" style="width: 100%; padding: 15px; font-size: 1.1rem;">
        <i class="fas fa-check-circle"></i> XEM LẠI ĐƠN HÀNG VÀ GỬI 
      </button>
    </div>

    <!-- ADMIN STATS SECTION -->
    <div id="statsSection" class="section admin-only">
      <h2>
        <i class="fas fa-chart-bar"></i> Thống kê 
        <span class="admin-badge">Admin</span>
      </h2>
      
      <div class="flex">
        <input type="date" id="statsDate" style="flex: 1;">
        <button onclick="showTodayStats()">Hôm nay</button>
        <button onclick="showAllStats()">Tất cả</button>
        <button onclick="loadOrders()"><i class="fas fa-sync-alt"></i> Làm mới</button>
      </div>
      
      <div class="stats-container">
        <div class="stat-box">
          <div class="stat-label">Tổng đơn</div>
          <div class="stat-value" id="totalOrders">0</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Doanh thu</div>
          <div class="stat-value" id="totalRevenue">0đ</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Đơn cao nhất</div>
          <div class="stat-value" id="highestOrder">0đ</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Món bán chạy</div>
          <div class="stat-value" id="bestSeller">-</div>
        </div>
      </div>
      
      <div id="recentOrders" style="margin-top: 20px;"></div>
    </div>

    <!-- ADMIN ORDERS SECTION -->
    <div id="ordersSection" class="section admin-only">
      <h2>
        <i class="fas fa-list"></i> Quản lý đơn hàng 
        <span class="admin-badge">Admin</span>
      </h2>
      
      <div class="flex">
        <input type="text" id="searchOrders" placeholder="Tìm kiếm (SĐT, tên, địa chỉ...)" style="flex: 2;">
        <select id="orderStatus" style="flex: 1;">
          <option value="all">Tất cả</option>
          <option value="new">Mới</option>
          <option value="processing">Đang xử lý</option>
          <option value="completed">Hoàn thành</option>
        </select>
      </div>
      
      <div id="ordersList" style="max-height: 500px; overflow-y: auto;"></div>
    </div>

    <!-- ADMIN MENU SECTION -->
    <div id="menuSection" class="section admin-only">
      <h2>
        <i class="fas fa-utensils"></i> Quản lý menu 
        <span class="admin-badge">Admin</span>
      </h2>
      
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <h3>Thêm món mới</h3>
        <div class="flex">
          <input type="text" id="menuName" placeholder="Tên món" style="flex: 2;">
          <input type="number" id="menuPriceS" placeholder="Giá S" style="flex: 1;">
          <input type="number" id="menuPriceL" placeholder="Giá L" style="flex: 1;">
          <select id="menuCategory" style="flex: 1;">
            <option value="TRÀ">TRÀ</option>
            <option value="SODA">SODA</option>
            <option value="SINH TỐ">SINH TỐ</option>
            <option value="ĐÁ XAY">ĐÁ XAY</option>
            <option value="CÀ PHÊ">CÀ PHÊ</option>
            <option value="TRÀ SỮA">TRÀ SỮA</option>
            <option value="SỮA CHUA">SỮA CHUA</option>
            <option value="NƯỚC ÉP">NƯỚC ÉP</option>
            <option value="PIZZA">PIZZA</option>
            <option value="ĐỒ ĂN VẶT">ĐỒ ĂN VẶT</option>
            <option value="MỲ CAY">MỲ CAY</option>
            <option value="BÚN ĐẬU">BÚN ĐẬU</option>
          </select>
          <button onclick="addMenuItem()"><i class="fas fa-plus"></i> Thêm</button>
        </div>
        <small><i class="fas fa-info-circle"></i> Nếu món chỉ có 1 size, nhập giá vào ô S và để trống ô L</small>
      </div>
      
      <div class="category-filter" id="adminCategoryFilter"></div>
      
      <div style="max-height: 400px; overflow-y: auto;">
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Tên món</th>
              <th>Danh mục</th>
              <th>Giá S</th>
              <th>Giá L</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody id="menuTableBody"></tbody>
        </table>
      </div>
    </div>
    
    <!-- ADMIN TOPPING CONTROL -->
    <div id="toppingSection" class="section admin-only">
      <h2>
        <i class="fas fa-cookie-bite"></i> Quản lý topping 
        <span class="admin-badge">Admin</span>
      </h2>
      
      <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
        <div style="flex: 1; min-width: 200px; text-align: center;">
          <div style="font-weight: bold; margin-bottom: 10px;">Trân châu trắng</div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="updateToppingStatus('white', 'available')" style="background: var(--success);">Còn</button>
            <button onclick="updateToppingStatus('white', 'out')" style="background: var(--danger);">Hết</button>
          </div>
          <div id="whiteToppingTime" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
        </div>
        
        <div style="flex: 1; min-width: 200px; text-align: center;">
          <div style="font-weight: bold; margin-bottom: 10px;">Trân châu đen</div>
          <div style="display: flex; gap: 10px; justify-content: center;">
            <button onclick="updateToppingStatus('black', 'available')" style="background: var(--success);">Còn</button>
            <button onclick="updateToppingStatus('black', 'out')" style="background: var(--danger);">Hết</button>
          </div>
          <div id="blackToppingTime" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <h2><i class="fas fa-lock"></i> Đăng nhập quản lý</h2>
      <input type="password" id="adminPassword" placeholder="Mật khẩu" style="width: 100%; margin: 15px 0;">
      <button onclick="checkLogin()" style="width: 100%;">Đăng nhập</button>
    </div>
  </div>

  <!-- Confirm Order Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-check-circle" style="color: var(--success);"></i> Xác nhận đơn hàng</h2>
        <span class="close" onclick="closeConfirmModal()">&times;</span>
      </div>
      
      <div id="confirmContent">
        <div class="confirm-info">
          <p><i class="fas fa-phone-alt"></i> <span id="confirmPhone"></span></p>
          <p><i class="fas fa-map-marker-alt"></i> <span id="confirmAddress"></span></p>
          <p><i class="fas fa-pencil-alt"></i> <span id="confirmNote"></span></p>
        </div>
        
        <h3>Món đã chọn:</h3>
        <div class="confirm-items" id="confirmItems"></div>
        
        <div class="confirm-total" id="confirmTotal"></div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="closeConfirmModal()" class="warning" style="flex: 1;">
          <i class="fas fa-edit"></i> Sửa lại
        </button>
        <button onclick="createOrder()" class="success" style="flex: 2;">
          <i class="fas fa-paper-plane"></i> XÁC NHẬN GỬI
        </button>
      </div>
    </div>
  </div>

  <!-- Order Detail Modal -->
  <div id="orderDetailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Chi tiết đơn hàng</h2>
        <span class="close" onclick="closeOrderDetailModal()">&times;</span>
      </div>
      <div id="orderDetailContent"></div>
    </div>
  </div>

  <!-- Out of Stock Notification Modal -->
  <div id="outOfStockModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Thông báo</h2>
        <span class="close" onclick="closeOutOfStockModal()">&times;</span>
      </div>
      <div id="outOfStockContent" style="text-align: center; padding: 20px;">
        <p id="outOfStockMessage"></p>
      </div>
      <button onclick="closeOutOfStockModal()" style="margin-top: 20px; width: 100%;">Đóng</button>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // =============================================
    // CẤU HÌNH TELEGRAM
    // =============================================
    const TELEGRAM_BOT_TOKEN = "8628768143:AAH7KlHFMESJNDYUQN_TkXBqSVblnM_r82o";
    const TELEGRAM_CHAT_ID = "6315315253";
    const ADMIN_PASSWORD = "admin123";

    // =============================================
    // DỮ LIỆU MENU (ĐẦY ĐỦ 95 MÓN)
    // =============================================
    let menuItems = [
      // TRÀ (18 món) - Có size L
      { id: 1, name: "Trà chanh", priceS: 10000, priceL: 15000, category: "TRÀ", hasSize: true },
      { id: 2, name: "Trà chanh nha đam", priceS: 15000, priceL: 20000, category: "TRÀ", hasSize: true },
      { id: 3, name: "Trà quất", priceS: 10000, priceL: 15000, category: "TRÀ", hasSize: true },
      { id: 4, name: "Trà quất nha đam", priceS: 15000, priceL: 20000, category: "TRÀ", hasSize: true },
      { id: 5, name: "Trà dưa lưới", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 6, name: "Trà đào", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 7, name: "Trà đào cam xả", priceS: 25000, priceL: 30000, category: "TRÀ", hasSize: true },
      { id: 8, name: "Trà quất lắc sữa", priceS: 25000, priceL: 30000, category: "TRÀ", hasSize: true },
      { id: 9, name: "Trà táo xanh", priceS: 25000, priceL: 30000, category: "TRÀ", hasSize: true },
      { id: 10, name: "Trà vải", priceS: 25000, priceL: 30000, category: "TRÀ", hasSize: true },
      { id: 11, name: "Trà dâu", priceS: 25000, priceL: 30000, category: "TRÀ", hasSize: true },
      { id: 12, name: "Trà hoa quả nhiệt đới", priceS: 25000, priceL: 30000, category: "TRÀ", hasSize: true },
      { id: 13, name: "Trà chanh bạc hà", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 14, name: "Trà chanh dâu", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 15, name: "Trà xoài chanh leo", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 16, name: "Trà đào chanh dây", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 17, name: "Trà đào nhài", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      { id: 18, name: "Trà chanh leo", priceS: 20000, priceL: 25000, category: "TRÀ", hasSize: true },
      
      // SODA (4 món)
      { id: 19, name: "Soda việt quất", price: 20000, category: "SODA", hasSize: false },
      { id: 20, name: "Soda bạc hà", price: 20000, category: "SODA", hasSize: false },
      { id: 21, name: "Soda dâu", price: 20000, category: "SODA", hasSize: false },
      { id: 22, name: "Soda dưa lưới", price: 20000, category: "SODA", hasSize: false },
      
      // SINH TỐ (3 món)
      { id: 23, name: "Sinh tố bơ", price: 30000, category: "SINH TỐ", hasSize: false },
      { id: 24, name: "Sinh tố xoài", price: 30000, category: "SINH TỐ", hasSize: false },
      { id: 25, name: "Sinh tố dâu tây", price: 30000, category: "SINH TỐ", hasSize: false },
      
      // ĐÁ XAY (4 món)
      { id: 26, name: "Đá xay việt quất", price: 35000, category: "ĐÁ XAY", hasSize: false },
      { id: 27, name: "Đá xay matcha", price: 35000, category: "ĐÁ XAY", hasSize: false },
      { id: 28, name: "Đá xay bạc hà", price: 35000, category: "ĐÁ XAY", hasSize: false },
      { id: 29, name: "Đá xay khoai môn", price: 35000, category: "ĐÁ XAY", hasSize: false },
      
      // CÀ PHÊ (3 món)
      { id: 30, name: "Cà phê bạc xỉu", price: 25000, category: "CÀ PHÊ", hasSize: false },
      { id: 31, name: "Cà phê nâu sữa", price: 20000, category: "CÀ PHÊ", hasSize: false },
      { id: 32, name: "Cà phê nâu nóng", price: 20000, category: "CÀ PHÊ", hasSize: false },
      
      // TRÀ SỮA (25 món) - Có size L
      { id: 33, name: "Trà sữa khoai môn", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 34, name: "Trà sữa sốt xoài", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 35, name: "Trà sữa socola", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 36, name: "Trà sữa matcha", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 37, name: "Trà sữa dưa lưới", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 38, name: "Trà sữa hồng trà", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 39, name: "Trà sữa dâu", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 40, name: "Trà sữa đào", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 41, name: "Trà sữa dừa", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 42, name: "Trà sữa lá nếp", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 43, name: "Trà sữa táo xanh", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 44, name: "Trà sữa caramen", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 45, name: "Trà sữa hạt dẻ", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 46, name: "Trà sữa cacao", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 47, name: "Trà sữa việt quất", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 48, name: "Trà sữa matcha latte", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 49, name: "Trà sữa bạc hà", priceS: 25000, priceL: 30000, category: "TRÀ SỮA", hasSize: true },
      { id: 50, name: "Trà sữa khoai lang tím", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 51, name: "Trà sữa trân châu đường đen", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 52, name: "Trà sữa kem trứng dừa nướng", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 53, name: "Trà sữa sốt xoài kem bông", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 54, name: "Trà sữa xoài matcha", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 55, name: "Trà sữa khoai môn kem dừa nướng", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 56, name: "Trà sữa đường đen kem dừa nướng", priceS: 30000, priceL: 35000, category: "TRÀ SỮA", hasSize: true },
      { id: 57, name: "Trà sữa khoai lang tím kem trứng", priceS: 35000, priceL: 40000, category: "TRÀ SỮA", hasSize: true },
      
      // SỮA CHUA (4 món)
      { id: 58, name: "Sữa chua lắc dâu", price: 25000, category: "SỮA CHUA", hasSize: false },
      { id: 59, name: "Sữa chua lắc xoài", price: 25000, category: "SỮA CHUA", hasSize: false },
      { id: 60, name: "Sữa chua lắc việt quất", price: 25000, category: "SỮA CHUA", hasSize: false },
      { id: 61, name: "Sữa chua hoa quả", price: 30000, category: "SỮA CHUA", hasSize: false },
      
      // NƯỚC ÉP (3 món) - Có size L
      { id: 62, name: "Nước ép cam", priceS: 25000, priceL: 30000, category: "NƯỚC ÉP", hasSize: true },
      { id: 63, name: "Nước ép dưa hấu", priceS: 25000, priceL: 30000, category: "NƯỚC ÉP", hasSize: true },
      { id: 64, name: "Nước ép dứa", priceS: 25000, priceL: 30000, category: "NƯỚC ÉP", hasSize: true },
      
      // PIZZA (3 món)
      { id: 65, name: "Pizza xúc xích", price: 60000, category: "PIZZA", hasSize: false },
      { id: 66, name: "Pizza bò ngô", price: 60000, category: "PIZZA", hasSize: false },
      { id: 67, name: "Pizza thập cẩm", price: 60000, category: "PIZZA", hasSize: false },
      
      // ĐỒ ĂN VẶT (18 món)
      { id: 68, name: "Xúc xích", price: 8000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 69, name: "Lạp xưởng", price: 8000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 70, name: "Phô mai que", price: 8000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 71, name: "Hướng dương đen", price: 15000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 72, name: "Hướng dương trắng", price: 15000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 73, name: "Khoai lang kén", price: 25000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 74, name: "Khoai tây chiên", price: 25000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 75, name: "Nem chua rán", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 76, name: "Khoai môn lệ phố", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 77, name: "Mực vòng chiên", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 78, name: "Gà viên chiên", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 79, name: "Gà viên chiên sốt cay", price: 35000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 80, name: "Đùi gà KFC", price: 25000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 81, name: "Đùi gà KFC sốt cay", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 82, name: "Cánh gà KFC", price: 25000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 83, name: "Cánh gà KFC sốt cay", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 84, name: "Cá viên chiên", price: 25000, category: "ĐỒ ĂN VẶT", hasSize: false },
      { id: 85, name: "Cá viên chiên sốt cay", price: 30000, category: "ĐỒ ĂN VẶT", hasSize: false },
      
      // MỲ CAY (5 món)
      { id: 86, name: "Mỳ cay xúc xích", price: 40000, category: "MỲ CAY", hasSize: false },
      { id: 87, name: "Mỳ cay bò", price: 45000, category: "MỲ CAY", hasSize: false },
      { id: 88, name: "Mỳ cay sườn sụn", price: 45000, category: "MỲ CAY", hasSize: false },
      { id: 89, name: "Mỳ cay hải sản", price: 50000, category: "MỲ CAY", hasSize: false },
      { id: 90, name: "Mỳ cay thập cẩm", price: 55000, category: "MỲ CAY", hasSize: false },
      
      // BÚN ĐẬU (5 món)
      { id: 91, name: "Bún đậu đầy đủ", price: 35000, category: "BÚN ĐẬU", hasSize: false },
      { id: 92, name: "Bún đậu thêm bún", price: 40000, category: "BÚN ĐẬU", hasSize: false },
      { id: 93, name: "Bún đậu thêm đậu", price: 40000, category: "BÚN ĐẬU", hasSize: false },
      { id: 94, name: "Bún đậu thêm chả cốm", price: 45000, category: "BÚN ĐẬU", hasSize: false },
      { id: 95, name: "Bún đậu thêm dồi sụn", price: 45000, category: "BÚN ĐẬU", hasSize: false }
    ];

    // =============================================
    // BIẾN TOÀN CỤC
    // =============================================
    let orders = JSON.parse(localStorage.getItem('orders')) || [];
    let cart = [];
    let isLoggedIn = false;
    let currentCategory = "TẤT CẢ";
    let selectedSizes = {};
    
    // Topping status
    let toppingStatus = JSON.parse(localStorage.getItem('toppingStatus')) || {
      white: { status: 'available', lastUpdate: null },
      black: { status: 'available', lastUpdate: null }
    };

    // =============================================
    // KHỞI TẠO
    // =============================================
    function init() {
      renderCategoryFilter();
      renderMenu();
      renderCart();
      updateToppingDisplay();
      startTelegramPolling();
      
      // Kiểm tra trạng thái đăng nhập
      const savedLogin = localStorage.getItem('isLoggedIn');
      if (savedLogin === 'true') {
        isLoggedIn = true;
        showAdminSections();
        loadOrders();
      }
      updateAuthButtons();
    }

    // =============================================
    // TELEGRAM POLLING - LẮNG NGHE LỆNH HẾT MÓN
    // =============================================
    let lastUpdateId = 0;
    
    function startTelegramPolling() {
      // Poll mỗi 10 giây để kiểm tra tin nhắn mới từ Telegram
      setInterval(checkTelegramMessages, 10000);
    }
    
    async function checkTelegramMessages() {
      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${lastUpdateId + 1}&timeout=5`);
        const data = await response.json();
        
        if (data.ok && data.result.length > 0) {
          data.result.forEach(update => {
            if (update.message && update.message.text) {
              processTelegramCommand(update.message.text);
              lastUpdateId = update.update_id;
            }
          });
        }
      } catch (error) {
        console.error('Lỗi polling Telegram:', error);
      }
    }
    
    function processTelegramCommand(text) {
      const command = text.toLowerCase().trim();
      
      // Xử lý lệnh hết trân châu
      if (command.includes('hết trân châu trắng') || command.includes('hết trắng')) {
        updateToppingStatus('white', 'out', true);
      } else if (command.includes('còn trân châu trắng') || command.includes('có trắng')) {
        updateToppingStatus('white', 'available', true);
      } else if (command.includes('hết trân châu đen') || command.includes('hết đen')) {
        updateToppingStatus('black', 'out', true);
      } else if (command.includes('còn trân châu đen') || command.includes('có đen')) {
        updateToppingStatus('black', 'available', true);
      }
    }

    // =============================================
    // QUẢN LÝ TRẠNG THÁI TOPPING
    // =============================================
    function updateToppingStatus(type, status, fromTelegram = false) {
      if (type === 'white') {
        toppingStatus.white.status = status;
        toppingStatus.white.lastUpdate = new Date().toLocaleString('vi-VN');
      } else {
        toppingStatus.black.status = status;
        toppingStatus.black.lastUpdate = new Date().toLocaleString('vi-VN');
      }
      
      localStorage.setItem('toppingStatus', JSON.stringify(toppingStatus));
      updateToppingDisplay();
      
      if (fromTelegram) {
        showNotification(`Đã cập nhật trạng thái từ Telegram: ${type === 'white' ? 'Trân châu trắng' : 'Trân châu đen'} ${status === 'available' ? 'Còn' : 'Hết'}`);
      }
    }
    
    function updateToppingDisplay() {
      // Cập nhật hiển thị public
      const whiteEl = document.getElementById('whiteBubbleStatus');
      const blackEl = document.getElementById('blackBubbleStatus');
      
      whiteEl.textContent = toppingStatus.white.status === 'available' ? 'Còn' : 'Hết';
      whiteEl.className = toppingStatus.white.status === 'available' ? 'status-available' : 'status-out';
      
      blackEl.textContent = toppingStatus.black.status === 'available' ? 'Còn' : 'Hết';
      blackEl.className = toppingStatus.black.status === 'available' ? 'status-available' : 'status-out';
      
      // Cập nhật thời gian trong admin
      if (isLoggedIn) {
        document.getElementById('whiteToppingTime').textContent = 
          toppingStatus.white.lastUpdate ? `Cập nhật: ${toppingStatus.white.lastUpdate}` : '';
        document.getElementById('blackToppingTime').textContent = 
          toppingStatus.black.lastUpdate ? `Cập nhật: ${toppingStatus.black.lastUpdate}` : '';
      }
    }

    // =============================================
    // KIỂM TRA MÓN HẾT TRƯỚC KHI ĐẶT
    // =============================================
    function checkOutOfStockItems() {
      const outOfStockItems = [];
      
      // Kiểm tra nếu có món trà sữa mà topping hết
      const hasMilkTea = cart.some(item => 
        item.originalName && item.originalName.toLowerCase().includes('trà sữa')
      );
      
      if (hasMilkTea) {
        if (toppingStatus.white.status === 'out') {
          outOfStockItems.push('Trân châu trắng');
        }
        if (toppingStatus.black.status === 'out') {
          outOfStockItems.push('Trân châu đen');
        }
      }
      
      return outOfStockItems;
    }

    // =============================================
    // HIỂN THỊ MENU
    // =============================================
    function renderCategoryFilter() {
      const filterDiv = document.getElementById('categoryFilter');
      filterDiv.innerHTML = '<button class="category-btn active" onclick="filterByCategory(\'TẤT CẢ\')">TẤT CẢ</button>';
      
      const categories = [...new Set(menuItems.map(item => item.category))];
      categories.sort().forEach(cat => {
        filterDiv.innerHTML += `<button class="category-btn" onclick="filterByCategory('${cat}')">${cat}</button>`;
      });
    }

    function filterByCategory(category) {
      currentCategory = category;
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === category || (category === 'TẤT CẢ' && btn.textContent === 'TẤT CẢ')) {
          btn.classList.add('active');
        }
      });
      renderMenu();
    }

    function renderMenu() {
      const menuGrid = document.getElementById('menuGrid');
      menuGrid.innerHTML = '';
      
      let filtered = menuItems;
      if (currentCategory !== 'TẤT CẢ') {
        filtered = menuItems.filter(item => item.category === currentCategory);
      }
      
      filtered.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'menu-item';
        
        if (item.hasSize) {
          // Món có 2 size
          const sizeKey = `size_${item.id}`;
          if (!selectedSizes[sizeKey]) selectedSizes[sizeKey] = 'S';
          
          itemDiv.innerHTML = `
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">
              <span class="price-small">S: ${item.priceS.toLocaleString()}đ</span>
              <span class="price-large">L: ${item.priceL.toLocaleString()}đ</span>
            </div>
            <div class="size-selector">
              <button class="size-btn ${selectedSizes[sizeKey] === 'S' ? 'small-active' : ''}" onclick="selectSize(${item.id}, 'S', event)">Size S</button>
              <button class="size-btn ${selectedSizes[sizeKey] === 'L' ? 'large-active' : ''}" onclick="selectSize(${item.id}, 'L', event)">Size L</button>
            </div>
            <button class="add-to-cart-btn" onclick="addToCartWithSize(${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.priceS}, ${item.priceL}, '${selectedSizes[sizeKey]}')">
              <i class="fas fa-cart-plus"></i> Thêm
            </button>
          `;
        } else {
          // Món 1 size
          itemDiv.innerHTML = `
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">
              <span class="price-single">${item.price.toLocaleString()}đ</span>
            </div>
            <button class="add-to-cart-btn" onclick="addToCart(${item.id}, '${item.name.replace(/'/g, "\\'")}', ${item.price})">
              <i class="fas fa-cart-plus"></i> Thêm
            </button>
          `;
        }
        
        menuGrid.appendChild(itemDiv);
      });
    }

    function selectSize(itemId, size, event) {
      event.stopPropagation();
      const sizeKey = `size_${itemId}`;
      selectedSizes[sizeKey] = size;
      renderMenu();
    }

    // =============================================
    // GIỎ HÀNG
    // =============================================
    function addToCartWithSize(id, name, priceS, priceL, size) {
      const price = size === 'S' ? priceS : priceL;
      const itemName = `${name} (Size ${size})`;
      
      const existing = cart.find(item => item.id === id && item.size === size);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ id, name: itemName, originalName: name, price, qty: 1, size });
      }
      renderCart();
      showNotification(`Đã thêm ${name} size ${size}`);
    }

    function addToCart(id, name, price) {
      const existing = cart.find(item => item.id === id && !item.size);
      if (existing) {
        existing.qty++;
      } else {
        cart.push({ id, name, price, qty: 1 });
      }
      renderCart();
      showNotification(`Đã thêm ${name}`);
    }

    function renderCart() {
      const tbody = document.getElementById('cartBody');
      tbody.innerHTML = '';
      let total = 0;
      
      if (cart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Giỏ hàng trống</td></tr>';
        document.getElementById('subtotal').textContent = '0đ';
        document.getElementById('cartTotal').textContent = '0đ';
        return;
      }
      
      cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        
        let sizeBadge = '';
        if (item.size) {
          sizeBadge = `<span class="size-badge ${item.size === 'S' ? 'size-s-badge' : 'size-l-badge'}">${item.size}</span>`;
        }
        
        tbody.innerHTML += `
          <tr>
            <td>${item.name} ${sizeBadge}</td>
            <td>
              <button onclick="updateCartQty(${index}, -1)">-</button>
              ${item.qty}
              <button onclick="updateCartQty(${index}, 1)">+</button>
            </td>
            <td>${item.price.toLocaleString()}đ</td>
            <td>${itemTotal.toLocaleString()}đ</td>
            <td><button onclick="removeFromCart(${index})" style="background: #dc3545;">X</button></td>
          </tr>
        `;
      });
      
      document.getElementById('subtotal').textContent = total.toLocaleString() + 'đ';
      document.getElementById('cartTotal').textContent = total.toLocaleString() + 'đ';
    }

    function updateCartQty(index, delta) {
      if (cart[index].qty + delta < 1) {
        removeFromCart(index);
      } else {
        cart[index].qty += delta;
        renderCart();
      }
    }

    function removeFromCart(index) {
      cart.splice(index, 1);
      renderCart();
    }

    // =============================================
    // XÁC NHẬN ĐƠN HÀNG
    // =============================================
    function showConfirmModal() {
      if (cart.length === 0) {
        showNotification('Giỏ hàng trống!', true);
        return;
      }
      
      // Kiểm tra món hết
      const outOfStock = checkOutOfStockItems();
      if (outOfStock.length > 0) {
        const message = `Xin lỗi, hiện tại quán đã hết: ${outOfStock.join(', ')}. Vui lòng chọn món khác hoặc đợi thêm.`;
        document.getElementById('outOfStockMessage').textContent = message;
        document.getElementById('outOfStockModal').style.display = 'flex';
        return;
      }
      
      const phone = document.getElementById('customerPhone').value.trim();
      const address = document.getElementById('customerAddress').value.trim();
      const note = document.getElementById('orderNote').value.trim() || 'Không có';
      
      if (!phone) {
        showNotification('Vui lòng nhập số điện thoại!', true);
        document.getElementById('customerPhone').focus();
        return;
      }
      
      if (!address) {
        showNotification('Vui lòng nhập địa chỉ!', true);
        document.getElementById('customerAddress').focus();
        return;
      }
      
      const phoneRegex = /(84|0[3|5|7|8|9])+([0-9]{8})\b/;
      if (!phoneRegex.test(phone)) {
        showNotification('Số điện thoại không hợp lệ!', true);
        return;
      }
      
      document.getElementById('confirmPhone').textContent = phone;
      document.getElementById('confirmAddress').textContent = address;
      document.getElementById('confirmNote').textContent = note;
      
      const itemsDiv = document.getElementById('confirmItems');
      itemsDiv.innerHTML = '';
      
      let total = 0;
      cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        itemsDiv.innerHTML += `
          <div class="confirm-item">
            <span>${item.name} x${item.qty}</span>
            <span>${itemTotal.toLocaleString()}đ</span>
          </div>
        `;
      });
      
      document.getElementById('confirmTotal').textContent = `Tổng cộng: ${total.toLocaleString()}đ`;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeConfirmModal() {
      document.getElementById('confirmModal').style.display = 'none';
    }
    
    function closeOutOfStockModal() {
      document.getElementById('outOfStockModal').style.display = 'none';
    }

    // =============================================
    // TẠO ĐƠN HÀNG
    // =============================================
    async function createOrder() {
      closeConfirmModal();
      
      // Kiểm tra lại lần cuối trước khi tạo đơn
      const outOfStock = checkOutOfStockItems();
      if (outOfStock.length > 0) {
        const message = `Xin lỗi, hiện tại quán đã hết: ${outOfStock.join(', ')}. Đơn hàng không thể gửi.`;
        document.getElementById('outOfStockMessage').textContent = message;
        document.getElementById('outOfStockModal').style.display = 'flex';
        return;
      }
      
      const phone = document.getElementById('customerPhone').value.trim();
      const address = document.getElementById('customerAddress').value.trim();
      const note = document.getElementById('orderNote').value;
      const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      const now = new Date();
      
      const order = {
        id: Date.now(),
        items: cart.map(item => ({
          name: item.name,
          originalName: item.originalName || item.name,
          size: item.size || 'M',
          price: item.price,
          qty: item.qty
        })),
        customer: { phone, address },
        note,
        total,
        time: now.toLocaleString('vi-VN'),
        date: now.toISOString().split('T')[0],
        status: 'new'
      };
      
      // Gửi Telegram
      let message = `<b>☕ BII COFFEE - ĐƠN HÀNG MỚI #${order.id}</b>\n\n`;
      message += `🕒 <b>Thời gian đặt hàng:</b> ${order.time}\n`;
      message += `📞 <b>SĐT ship:</b> ${order.customer.phone}\n`;
      message += `🏠 <b>Địa chỉ ship hàng:</b> ${order.customer.address}\n`;
      message += `📝 <b>Ghi chú:</b> ${note || 'Không có'}\n\n`;
      message += `<b>CHI TIẾT MÓN:</b>\n`;
      order.items.forEach(item => {
        message += `${item.name} x${item.qty} - ${(item.price * item.qty).toLocaleString()}đ\n`;
      });
      message += `\n<b>💰 TỔNG CỘNG: ${total.toLocaleString()}đ</b>\n`;
      
      // Thêm thông báo topping nếu hết
      if (toppingStatus.white.status === 'out' || toppingStatus.black.status === 'out') {
        message += `\n⚠️ <b>LƯU Ý:</b> `;
        if (toppingStatus.white.status === 'out') message += `Trân châu trắng đã hết. `;
        if (toppingStatus.black.status === 'out') message += `Trân châu đen đã hết. `;
      }
      
      message += `\n💝 <b>Cảm ơn quý khách!</b>`;
      
      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: message,
            parse_mode: 'HTML'
          })
        });
        
        if (response.ok) {
          showNotification(`Đặt hàng thành công! Mã đơn: #${order.id}`);
        } else {
          showNotification('Đã tạo đơn nhưng không gửi được Telegram', true);
        }
      } catch (error) {
        console.error('Lỗi gửi Telegram:', error);
        showNotification('Đã tạo đơn nhưng không gửi được Telegram', true);
      }
      
      orders.push(order);
      localStorage.setItem('orders', JSON.stringify(orders));
      
      cart = [];
      document.getElementById('customerPhone').value = '';
      document.getElementById('customerAddress').value = '';
      document.getElementById('orderNote').value = '';
      renderCart();
      
      if (isLoggedIn) {
        loadOrders();
        renderStats();
      }
    }

    // =============================================
    // ĐĂNG NHẬP / ĐĂNG XUẤT
    // =============================================
    function showLoginModal() {
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('adminPassword').focus();
    }

    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('adminPassword').value = '';
    }

    function checkLogin() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isLoggedIn = true;
        localStorage.setItem('isLoggedIn', 'true');
        showAdminSections();
        closeLoginModal();
        loadOrders();
        renderStats();
        updateToppingDisplay();
        showNotification('Đăng nhập thành công!');
      } else {
        showNotification('Sai mật khẩu!', true);
      }
    }

    function logout() {
      isLoggedIn = false;
      localStorage.setItem('isLoggedIn', 'false');
      hideAdminSections();
      showNotification('Đã đăng xuất');
    }

    function showAdminSections() {
      document.querySelectorAll('.admin-only').forEach(el => el.classList.add('visible'));
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('logoutBtn').style.display = 'block';
      renderMenuTable();
      renderAdminCategoryFilter();
      updateToppingDisplay();
    }

    function hideAdminSections() {
      document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('visible'));
      document.getElementById('loginBtn').style.display = 'block';
      document.getElementById('logoutBtn').style.display = 'none';
    }

    function updateAuthButtons() {
      if (isLoggedIn) {
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'block';
      } else {
        document.getElementById('loginBtn').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'none';
      }
    }

    // =============================================
    // QUẢN LÝ MENU (ADMIN)
    // =============================================
    function renderAdminCategoryFilter() {
      const filterDiv = document.getElementById('adminCategoryFilter');
      if (!filterDiv) return;
      
      filterDiv.innerHTML = '<button class="category-btn active" onclick="filterAdminCategory(\'TẤT CẢ\')">TẤT CẢ</button>';
      
      const categories = [...new Set(menuItems.map(item => item.category))];
      categories.sort().forEach(cat => {
        filterDiv.innerHTML += `<button class="category-btn" onclick="filterAdminCategory('${cat}')">${cat}</button>`;
      });
    }

    function filterAdminCategory(category) {
      document.querySelectorAll('#adminCategoryFilter .category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === category || (category === 'TẤT CẢ' && btn.textContent === 'TẤT CẢ')) {
          btn.classList.add('active');
        }
      });
      renderMenuTable(category);
    }

    function renderMenuTable(category = 'TẤT CẢ') {
      const tbody = document.getElementById('menuTableBody');
      if (!tbody) return;
      
      tbody.innerHTML = '';
      let filtered = menuItems;
      if (category !== 'TẤT CẢ') {
        filtered = menuItems.filter(item => item.category === category);
      }
      
      filtered.forEach((item, index) => {
        const originalIndex = menuItems.findIndex(m => m.id === item.id);
        const priceS = item.hasSize ? item.priceS : item.price;
        const priceL = item.hasSize ? item.priceL : '';
        
        tbody.innerHTML += `
          <tr>
            <td>${item.name}</td>
            <td>${item.category}</td>
            <td>${priceS.toLocaleString()}đ</td>
            <td>${priceL ? priceL.toLocaleString() + 'đ' : '-'}</td>
            <td>
              <button onclick="editMenuItem(${originalIndex})" style="background: #ffc107; color: #000; padding: 5px 10px;">Sửa</button>
              <button onclick="deleteMenuItem(${originalIndex})" style="background: #dc3545; padding: 5px 10px;">Xóa</button>
            </td>
          </tr>
        `;
      });
    }

    function addMenuItem() {
      const name = document.getElementById('menuName').value.trim();
      const priceS = parseInt(document.getElementById('menuPriceS').value);
      const priceL = parseInt(document.getElementById('menuPriceL').value);
      const category = document.getElementById('menuCategory').value;
      
      if (!name || isNaN(priceS) || priceS <= 0) {
        showNotification('Nhập tên món và giá S!', true);
        return;
      }
      
      const newId = Math.max(...menuItems.map(m => m.id)) + 1;
      
      if (!isNaN(priceL) && priceL > 0) {
        // Món có 2 size
        menuItems.push({ id: newId, name, priceS, priceL, category, hasSize: true });
      } else {
        // Món 1 size
        menuItems.push({ id: newId, name, price: priceS, category, hasSize: false });
      }
      
      localStorage.setItem('menuItems', JSON.stringify(menuItems));
      
      // Cập nhật giao diện
      renderCategoryFilter();
      renderMenu();
      renderMenuTable();
      renderAdminCategoryFilter();
      
      // Xóa form
      document.getElementById('menuName').value = '';
      document.getElementById('menuPriceS').value = '';
      document.getElementById('menuPriceL').value = '';
      
      showNotification('Đã thêm món!');
    }

    function editMenuItem(index) {
      const item = menuItems[index];
      document.getElementById('menuName').value = item.name;
      document.getElementById('menuPriceS').value = item.hasSize ? item.priceS : item.price;
      document.getElementById('menuPriceL').value = item.hasSize ? item.priceL : '';
      document.getElementById('menuCategory').value = item.category;
      
      // Xóa món cũ và thêm lại
      menuItems.splice(index, 1);
      localStorage.setItem('menuItems', JSON.stringify(menuItems));
      
      // Cập nhật giao diện
      renderCategoryFilter();
      renderMenu();
      renderMenuTable();
      renderAdminCategoryFilter();
      
      showNotification('Đã chuyển sang chế độ sửa, hãy nhập thông tin và thêm mới!');
    }

    function deleteMenuItem(index) {
      if (confirm('Xóa món này?')) {
        menuItems.splice(index, 1);
        localStorage.setItem('menuItems', JSON.stringify(menuItems));
        
        renderCategoryFilter();
        renderMenu();
        renderMenuTable();
        renderAdminCategoryFilter();
        
        showNotification('Đã xóa món!');
      }
    }

    // =============================================
    // QUẢN LÝ ĐƠN HÀNG (ADMIN)
    // =============================================
    function loadOrders() {
      orders = JSON.parse(localStorage.getItem('orders')) || [];
      renderOrders();
      renderStats();
    }

    function renderOrders() {
      const searchTerm = document.getElementById('searchOrders')?.value.toLowerCase() || '';
      const statusFilter = document.getElementById('orderStatus')?.value || 'all';
      
      let filtered = orders;
      
      if (searchTerm) {
        filtered = filtered.filter(o => 
          o.customer?.phone?.includes(searchTerm) ||
          o.customer?.address?.toLowerCase().includes(searchTerm) ||
          o.items.some(i => i.name.toLowerCase().includes(searchTerm))
        );
      }
      
      if (statusFilter !== 'all') {
        filtered = filtered.filter(o => o.status === statusFilter);
      }
      
      filtered.sort((a, b) => b.id - a.id);
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      
      if (filtered.length === 0) {
        ordersList.innerHTML = '<p class="empty-state">Không có đơn hàng</p>';
        return;
      }
      
      filtered.forEach(order => {
        const statusClass = order.status === 'new' ? 'status-new' : (order.status === 'processing' ? 'status-processing' : 'status-completed');
        const statusText = order.status === 'new' ? 'Mới' : (order.status === 'processing' ? 'Đang xử lý' : 'Hoàn thành');
        
        ordersList.innerHTML += `
          <div class="order-card">
            <div class="order-header">
              <strong>#${order.id}</strong>
              <span class="order-status ${statusClass}">${statusText}</span>
            </div>
            <div><i class="fas fa-phone"></i> ${order.customer?.phone}</div>
            <div><i class="fas fa-map-marker-alt"></i> ${order.customer?.address}</div>
            <div><i class="fas fa-clock"></i> ${order.time}</div>
            <div><i class="fas fa-coffee"></i> ${order.items.map(i => `${i.name} x${i.qty}`).join(', ')}</div>
            <div style="font-weight: bold; color: var(--primary); margin: 10px 0;">Tổng: ${order.total.toLocaleString()}đ</div>
            <div class="order-actions">
              <button onclick="viewOrderDetail(${order.id})" style="background: #17a2b8;">Chi tiết</button>
              <button onclick="updateOrderStatus(${order.id}, 'processing')" style="background: #ffc107;">Đang xử lý</button>
              <button onclick="updateOrderStatus(${order.id}, 'completed')" style="background: #28a745;">Hoàn thành</button>
              <button onclick="deleteOrder(${order.id})" style="background: #dc3545;">Xóa</button>
            </div>
          </div>
        `;
      });
    }

    function renderStats() {
      const dateInput = document.getElementById('statsDate').value;
      let filtered = orders;
      
      if (dateInput) {
        filtered = orders.filter(o => o.date === dateInput);
      }
      
      const totalOrders = filtered.length;
      const revenue = filtered.reduce((s, o) => s + o.total, 0);
      const highest = filtered.length ? Math.max(...filtered.map(o => o.total)) : 0;
      
      const itemCount = {};
      filtered.forEach(o => o.items.forEach(i => {
        itemCount[i.originalName || i.name] = (itemCount[i.originalName || i.name] || 0) + i.qty;
      }));
      const topItem = Object.entries(itemCount).sort((a,b) => b[1] - a[1])[0];
      
      document.getElementById('totalOrders').textContent = totalOrders;
      document.getElementById('totalRevenue').textContent = revenue.toLocaleString() + 'đ';
      document.getElementById('highestOrder').textContent = highest.toLocaleString() + 'đ';
      document.getElementById('bestSeller').textContent = topItem ? `${topItem[0]} (${topItem[1]})` : '-';
      
      const recent = filtered.slice(-5).reverse();
      let recentHtml = '<h3>Đơn hàng gần đây</h3><table style="width:100%"><tr><th>Mã</th><th>SĐT</th><th>Tiền</th></tr>';
      recent.forEach(o => {
        recentHtml += `<tr><td>#${o.id}</td><td>${o.customer?.phone}</td><td>${o.total.toLocaleString()}đ</td></tr>`;
      });
      recentHtml += '</table>';
      document.getElementById('recentOrders').innerHTML = recentHtml;
    }

    function showTodayStats() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('statsDate').value = today;
      renderStats();
    }

    function showAllStats() {
      document.getElementById('statsDate').value = '';
      renderStats();
    }

    function viewOrderDetail(id) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      
      const modal = document.getElementById('orderDetailModal');
      const content = document.getElementById('orderDetailContent');
      
      let itemsHtml = '';
      order.items.forEach(item => {
        itemsHtml += `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price.toLocaleString()}đ</td><td>${(item.price * item.qty).toLocaleString()}đ</td></tr>`;
      });
      
      content.innerHTML = `
        <h2>Đơn hàng #${order.id}</h2>
        <p><strong>Thời gian:</strong> ${order.time}</p>
        <p><strong>SĐT:</strong> ${order.customer?.phone}</p>
        <p><strong>Địa chỉ:</strong> ${order.customer?.address}</p>
        <p><strong>Ghi chú:</strong> ${order.note || 'Không có'}</p>
        <p><strong>Trạng thái:</strong> ${order.status}</p>
        
        <h3>Món đã gọi</h3>
        <table style="width:100%">
          <tr><th>Món</th><th>SL</th><th>Đơn giá</th><th>Thành tiền</th></tr>
          ${itemsHtml}
        </table>
        
        <p style="text-align:right; font-weight:bold; margin-top:10px;">Tổng: ${order.total.toLocaleString()}đ</p>
        
        <button onclick="document.getElementById('orderDetailModal').style.display='none'" style="margin-top:10px;">Đóng</button>
      `;
      
      modal.style.display = 'flex';
    }

    function closeOrderDetailModal() {
      document.getElementById('orderDetailModal').style.display = 'none';
    }

    function updateOrderStatus(id, status) {
      const order = orders.find(o => o.id === id);
      if (!order) return;
      
      order.status = status;
      localStorage.setItem('orders', JSON.stringify(orders));
      
      loadOrders();
      renderStats();
      showNotification(`Đã cập nhật trạng thái đơn #${id}`);
    }

    function deleteOrder(id) {
      if (!confirm(`Xóa đơn hàng #${id}?`)) return;
      
      orders = orders.filter(o => o.id !== id);
      localStorage.setItem('orders', JSON.stringify(orders));
      
      loadOrders();
      renderStats();
      showNotification(`Đã xóa đơn #${id}`);
    }

    // =============================================
    // THÔNG BÁO
    // =============================================
    function showNotification(message, isError = false) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification' + (isError ? ' error' : '') + ' show';
      setTimeout(() => notification.classList.remove('show'), 3000);
    }

    // =============================================
    // KHỞI CHẠY
    // =============================================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
