<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý đơn hàng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .menu-item-card { border: 1px solid #ddd; border-radius: 10px; }
  </style>
</head>
<body class="p-4">

  <h2 class="mb-3">📋 Quản lý đơn hàng</h2>

  <!-- MENU -->
  <div class="mb-4">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#menuModal">➕ Thêm món vào Menu</button>
    <div id="menuItemsContainer" class="row mt-3"></div>
  </div>

  <!-- TẠO ĐƠN HÀNG -->
  <div class="card p-3 mb-4">
    <h5>Tạo đơn hàng</h5>
    <select id="menuSelect" class="form-select mb-2"></select>
    <input type="number" id="orderQty" class="form-control mb-2" placeholder="Số lượng" value="1" min="1">
    <input type="text" id="orderNote" class="form-control mb-2" placeholder="Ghi chú (tùy chọn)">
    <button class="btn btn-success" onclick="addOrder()">✅ Thêm đơn</button>
  </div>

  <!-- DANH SÁCH ĐƠN -->
  <h5>Danh sách đơn hàng</h5>
  <input type="text" id="filterNote" class="form-control mb-2" placeholder="Lọc theo ghi chú...">
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>#</th><th>Món</th><th>SL</th><th>Thành tiền</th><th>Ghi chú</th><th>Hành động</th>
      </tr>
    </thead>
    <tbody id="ordersTable"></tbody>
  </table>

  <!-- Modal thêm/sửa món -->
  <div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Thêm món mới</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input id="itemName" class="form-control mb-2" placeholder="Tên món">
          <input id="itemPrice" class="form-control mb-2" placeholder="Giá" type="number">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="saveMenuItem">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal sửa đơn hàng -->
  <div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Sửa đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <select id="editMenuSelect" class="form-select mb-2"></select>
          <input type="number" id="editOrderQty" class="form-control mb-2" min="1">
          <input type="text" id="editOrderNote" class="form-control mb-2">
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" id="saveOrderEdit">Lưu thay đổi</button>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let menuItems = JSON.parse(localStorage.getItem("menuItems") || "[]");
let orders = JSON.parse(localStorage.getItem("orders") || "[]");
let editIndex = null;
let editOrderIndex = null;

// Render menu
function renderMenu(){
  const container = document.getElementById("menuItemsContainer");
  container.innerHTML = "";
  menuItems.forEach((item, index) => {
    container.innerHTML += `
      <div class="col-md-3 mb-3">
        <div class="card menu-item-card p-2 text-center">
          <h6>${item.name}</h6>
          <p>${item.price.toLocaleString()} đ</p>
          <div>
            <button class="btn btn-sm btn-warning" onclick="editMenuItem(${index})">✏️</button>
            <button class="btn btn-sm btn-danger" onclick="deleteMenuItem(${index})">🗑️</button>
          </div>
        </div>
      </div>`;
  });

  document.getElementById("menuSelect").innerHTML = menuItems.map((i, idx)=>
    `<option value="${idx}">${i.name} - ${i.price.toLocaleString()} đ</option>`).join("");

  document.getElementById("editMenuSelect").innerHTML = document.getElementById("menuSelect").innerHTML;

  localStorage.setItem("menuItems", JSON.stringify(menuItems));
}

// Thêm/sửa món
document.getElementById("saveMenuItem").addEventListener("click", ()=>{
  const name = document.getElementById("itemName").value;
  const price = parseInt(document.getElementById("itemPrice").value);
  if(name && price){
    if(editIndex !== null){
      menuItems[editIndex] = { name, price };
      editIndex = null;
    } else {
      menuItems.push({ name, price });
    }
    renderMenu();
    document.querySelector("#menuModal .btn-close").click();
    document.getElementById("itemName").value="";
    document.getElementById("itemPrice").value="";
  }
});

function editMenuItem(index){
  editIndex = index;
  document.getElementById("itemName").value = menuItems[index].name;
  document.getElementById("itemPrice").value = menuItems[index].price;
  new bootstrap.Modal(document.getElementById("menuModal")).show();
}

function deleteMenuItem(index){
  if(confirm("Xóa món này?")){
    menuItems.splice(index,1);
    renderMenu();
  }
}

// Đơn hàng
function renderOrders(filtered = null){
  const tb = document.getElementById("ordersTable");
  tb.innerHTML = "";
  const data = filtered || orders;
  data.forEach((o, i)=>{
    tb.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${o.name}</td>
        <td>${o.qty}</td>
        <td>${(o.price*o.qty).toLocaleString()} đ</td>
        <td>${o.note||""}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editOrder(${orders.indexOf(o)})">✏️</button>
          <button class="btn btn-sm btn-danger" onclick="deleteOrder(${orders.indexOf(o)})">🗑️</button>
        </td>
      </tr>`;
  });
  localStorage.setItem("orders", JSON.stringify(orders));
}

function addOrder(){
  const idx = document.getElementById("menuSelect").value;
  const qty = parseInt(document.getElementById("orderQty").value);
  const note = document.getElementById("orderNote").value;
  if(idx!=="" && qty>0){
    const item = menuItems[idx];
    orders.push({ name:item.name, price:item.price, qty, note });
    renderOrders();
    document.getElementById("orderQty").value=1;
    document.getElementById("orderNote").value="";
  }
}

function editOrder(i){
  editOrderIndex = i;
  document.getElementById("editMenuSelect").value = menuItems.findIndex(m=>m.name===orders[i].name);
  document.getElementById("editOrderQty").value = orders[i].qty;
  document.getElementById("editOrderNote").value = orders[i].note||"";
  new bootstrap.Modal(document.getElementById("orderModal")).show();
}

document.getElementById("saveOrderEdit").addEventListener("click", ()=>{
  const idx = document.getElementById("editMenuSelect").value;
  const qty = parseInt(document.getElementById("editOrderQty").value);
  const note = document.getElementById("editOrderNote").value;
  if(idx!=="" && qty>0){
    const item = menuItems[idx];
    orders[editOrderIndex] = { name:item.name, price:item.price, qty, note };
    renderOrders();
    editOrderIndex=null;
    document.querySelector("#orderModal .btn-close").click();
  }
});

function deleteOrder(i){
  if(confirm("Xóa đơn hàng này?")){
    orders.splice(i,1);
    renderOrders();
  }
}

// Lọc đơn hàng theo ghi chú
document.getElementById("filterNote").addEventListener("keyup", (e)=>{
  const keyword = e.target.value.toLowerCase();
  if(keyword === ""){
    renderOrders(); // hiển thị tất cả
  } else {
    const filtered = orders.filter(o => (o.note||"").toLowerCase().includes(keyword));
    renderOrders(filtered);
  }
});

// Khởi động
renderMenu();
renderOrders();
</script>
</body>
</html>
